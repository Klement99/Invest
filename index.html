<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Compound Interest Calculator</title>
  <link rel="apple-touch-icon" href="icons.png">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background-color: #1f2937; font-family: Arial, sans-serif; }
    #chartContainer, #barChartContainer { max-width: 100%; height: 300px; }
    canvas { background-color: #000000; border-radius: 8px; }
    /* Custom slider styling */
    input[type="range"] {
      -webkit-appearance: none;
      width: 100%;
      height: 8px;
      background: #4b5563;
      border-radius: 5px;
      outline: none;
      margin-top: 8px;
    }
    input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 20px;
      height: 20px;
      background: #3b82f6;
      border-radius: 50%;
      cursor: pointer;
    }
    input[type="range"]::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: #3b82f6;
      border-radius: 50%;
      cursor: pointer;
    }
    /* Fixed table headers */
    #yearlyTable thead th {
      position: sticky;
      top: 0;
      background-color: #374151;
      z-index: 10;
    }
    #yearlyTable {
      max-height: 300px;
      overflow-y: auto;
    }
    /* Table cell optimizations */
    #yearlyTable td {
      white-space: normal;
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 bg-gray-900 text-white">
  <div class="bg-gray-800 p-6 rounded-lg shadow-lg w-full max-w-md">
    <h1 class="text-2xl font-bold text-center mb-4 text-yellow-400">Compound Interest Calculator</h1>
    <h6 class="text-xs font-bold text-center mb-4 text-gray-400">Brought to you by Klement Marais</h6>
    <div class="mb-4">
      <label class="block text-sm font-medium text-gray-300">Select Preset</label>
      <select id="presetSelect" onchange="loadPreset()" class="mt-1 block w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white">
        <option value="none">Select a Preset</option>
        <option value="klement">Klement</option>
        <option value="sune">Sune</option>
        <option value="both">Both</option>
      </select>
    </div>
    <form id="calcForm" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-300">ðŸ’° Initial Cash Investment (R)</label>
        <input type="text" id="initialInvestment" value="0" pattern="[0-9\s]*" onfocus="unformatInput(this)" onblur="formatInput(this)" class="mt-1 block w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-300" id="yearsLabel">ðŸ“… Years Invested (1 Year)</label>
        <input type="range" id="years" value="1" min="1" max="50" step="1" oninput="updateYearsDisplay(this.value)" class="mt-1 block w-full">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-300">ðŸ’° Monthly Contribution (R)</label>
        <input type="text" id="monthlyContribution" value="0" pattern="[0-9\s]*" onfocus="unformatInput(this)" onblur="formatInput(this)" class="mt-1 block w-full p-2 border border-gray-600 rounded-md bg-gray-700 text-white">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-300" id="rateLabel">ðŸ“ˆ Annual Growth Rate (15%)</label>
        <input type="range" id="rate" value="15" min="5" max="25" step="1" oninput="updateRateDisplay(this.value)" class="mt-1 block w-full">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-300" id="inflationRateLabel">ðŸ“‰ Inflation Rate (6%)</label>
        <input type="range" id="inflationRate" value="6" min="5" max="10" step="1" oninput="updateInflationRateDisplay(this.value)" class="mt-1 block w-full">
      </div>
      <button type="button" onclick="calculate()" class="w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Calculate</button>
    </form>
    <div id="results" class="mt-6 space-y-2 hidden">
      <h2 class="text-lg font-semibold text-center text-yellow-400">Pre-Tax Results</h2>
      <p class="text-center"><strong>ðŸ“ˆ Investment Value:</strong> <span id="totalValue"></span></p>
      <p class="text-center"><strong>ðŸ“‰ Future Value (Total):</strong> <span id="totalRealValue"></span></p>
      <hr>
      <p class="text-center"><strong>ðŸ“ˆ Monthly Interest (End):</strong> <span id="monthlyInterest"></span></p>
      <p class="text-center"><strong>ðŸ“‰ Future Value (Interest):</strong> <span id="monthlyRealInterest"></span></p>
      <hr>
      <h2 class="text-lg font-semibold text-center text-yellow-400 mt-4">Post-Tax Results</h2>
      <p class="text-center"><strong>ðŸ’µ Total Cash Invested:</strong> <span id="totalInvested"></span></p>
      <p class="text-center"><strong>ðŸ’¸ Full Cash Out Value:</strong> <span id="postTaxTotal"></span></p>
      <hr>
      <p class="text-center"><strong>ðŸ“‰ Future Value (Total):</strong> <span id="postTaxRealTotal"></span></p>
      <p class="text-center"><strong>ðŸ“‰ Future Value (Interest):</strong> <span id="postTaxRealMonthlyInterest"></span></p>
      <p class="text-center"><strong>ðŸ“ˆ Monthly Interest:</strong> <span id="postTaxMonthlyInterest"></span></p>
      <p class="text-center text-green-500"><strong>ðŸ™‚ Effective Tax %:</strong> <span id="effectiveTaxPercent"></span></p>
      <hr>
      <p class="text-sm text-center text-gray-400 mt-2">Assumes CGT at effective 18% (40% inclusion, R40k exclusion) & interest exemption (R23.8k/yr at 45% top bracket).</p>
    </div>
    <div class="mt-6 flex items-center justify-center">
      <label class="text-sm font-medium text-gray-300">
        <input type="checkbox" id="logScaleToggle" onchange="calculate()"> Use Logarithmic Scale
      </label>
    </div>
    <details class="mt-6 bg-gray-700 rounded-lg">
      <summary class="p-3 text-sm font-medium text-gray-300 cursor-pointer hover:bg-gray-600 rounded-lg">How it Works</summary>
      <div class="p-3 text-sm text-gray-300">
        <p>This calculator estimates your investment growth with monthly contributions, adjusted for inflation and South African taxes (SARS 2025 rules).</p>
        <ul class="list-disc ml-5 mt-2">
          <li><strong>Growth</strong>: Calculates compound interest with monthly contributions, based on your initial investment, monthly contributions, growth rate, and years invested.</li>
          <li><strong>Inflation</strong>: Adjusts values to show real purchasing power based on the inflation rate.</li>
          <li><strong>Taxes</strong>: Applies Capital Gains Tax (18% effective rate, R40,000 exclusion) on gains and 45% tax on interest after a R23,800 annual exemption.</li>
          <li><strong>Outputs</strong>: Shows pre-tax and post-tax values and interest (nominal and inflation-adjusted) in results, charts, and yearly tables.</li>
        </ul>
      </div>
    </details>
    <div id="chartContainer" class="mt-2 hidden">
      <canvas id="growthChart"></canvas>
    </div>
    <div id="barChartContainer" class="mt-6 hidden">
      <canvas id="postTaxBarChart"></canvas>
    </div>
    <div id="yearlyTable" class="mt-6 hidden">
      <h2 class="text-lg font-semibold text-center text-yellow-400">Yearly Breakdown</h2>
      <div class="mt-6 flex items-center justify-center">
        <label class="text-sm font-medium text-gray-300">
          <input type="checkbox" id="showAllYears" onchange="calculate()"> Show All Years
        </label>
      </div>
      <div class="overflow-x-auto">
        <details class="mt-6 bg-gray-700 rounded-lg">
          <summary class="p-3 text-md font-semibold text-yellow-400 cursor-pointer hover:bg-gray-600 rounded-lg">Value Breakdown</summary>
          <div class="p-3">
            <table class="w-full text-xs sm:text-sm border border-gray-600 table-auto">
              <thead class="bg-gray-700">
                <tr>
                  <th class="p-2 sm:p-3 border border-gray-600 text-center text-white min-w-[50px] sm:min-w-[60px]">Year</th>
                  <th class="p-2 sm:p-3 border border-gray-600 text-center text-white min-w-[100px] sm:min-w-[120px]">Value</th>
                  <th class="p-2 sm:p-3 border border-gray-600 text-center text-white min-w-[100px] sm:min-w-[120px]">Future Value</th>
                </tr>
              </thead>
              <tbody id="tableBodyValue" class="text-center"></tbody>
            </table>
          </div>
        </details>
        <details class="mt-6 bg-gray-700 rounded-lg">
          <summary class="p-3 text-md font-semibold text-yellow-400 cursor-pointer hover:bg-gray-600 rounded-lg">Interest Breakdown</summary>
          <div class="p-3">
            <table class="w-full text-xs sm:text-sm border border-gray-600 table-auto">
              <thead class="bg-gray-700">
                <tr>
                  <th class="p-2 sm:p-3 border border-gray-600 text-center text-white min-w-[50px] sm:min-w-[60px]">Year</th>
                  <th class="p-2 sm:p-3 border border-gray-600 text-center text-white min-w-[100px] sm:min-w-[120px]">Interest</th>
                  <th class="p-2 sm:p-3 border border-gray-600 text-center text-white min-w-[100px] sm:min-w-[120px]">Future Interest</th>
                </tr>
              </thead>
              <tbody id="tableBodyInterest" class="text-center"></tbody>
            </table>
          </div>
        </details>
        <details class="mt-6 bg-gray-700 rounded-lg">
          <summary class="p-3 text-md font-semibold text-yellow-400 cursor-pointer hover:bg-gray-600 rounded-lg">Post-Tax Interest Breakdown</summary>
          <div class="p-3">
            <table class="w-full text-xs sm:text-sm border border-gray-600 table-auto">
              <thead class="bg-gray-700">
                <tr>
                  <th class="p-2 sm:p-3 border border-gray-600 text-center text-white min-w-[50px] sm:min-w-[60px]">Year</th>
                  <th class="p-2 sm:p-3 border border-gray-600 text-center text-white min-w-[100px] sm:min-w-[120px]">(PT) Interest</th>
                  <th class="p-2 sm:p-3 border border-gray-600 text-center text-white min-w-[100px] sm:min-w-[120px]">(PT) Future Interest</th>
                </tr>
              </thead>
              <tbody id="tableBodyPostTaxInterest" class="text-center"></tbody>
            </table>
          </div>
        </details>
      </div>
    </div>
  </div>
  <script>
    let chart = null;
    let barChart = null;

    // Hardcoded presets
    const presets = {
      klement: {
        initialInvestment: 1400000,
        years: 15,
        monthlyContribution: 20000,
        rate: 16,
        inflationRate: 6
      },
      sune: {
        initialInvestment: 700000,
        years: 15,
        monthlyContribution: 10000,
        rate: 16,
        inflationRate: 6
      },
      both: {
        initialInvestment: 2000000,
        years: 25,
        monthlyContribution: 30000,
        rate: 15,
        inflationRate: 6
      }
    };

    // Function to load a preset
    function loadPreset() {
      const presetName = document.getElementById('presetSelect').value;
      if (presetName === 'none') return;

      const preset = presets[presetName];
      document.getElementById('initialInvestment').value = preset.initialInvestment.toLocaleString('en-ZA', { minimumFractionDigits: 0 });
      document.getElementById('years').value = preset.years;
      document.getElementById('monthlyContribution').value = preset.monthlyContribution.toLocaleString('en-ZA', { minimumFractionDigits: 0 });
      document.getElementById('rate').value = preset.rate;
      document.getElementById('inflationRate').value = preset.inflationRate;

      // Update slider displays
      updateYearsDisplay(preset.years);
      updateRateDisplay(preset.rate);
      updateInflationRateDisplay(preset.inflationRate);
    }

    // Function to update years display
    function updateYearsDisplay(value) {
      document.getElementById('yearsLabel').textContent = `ðŸ“… Years Invested (${value} Year${value > 1 ? 's' : ''})`;
    }

    // Function to update annual growth rate display
    function updateRateDisplay(value) {
      document.getElementById('rateLabel').textContent = `ðŸ“ˆ Annual Growth Rate (${value}%)`;
    }

    // Function to update inflation rate display
    function updateInflationRateDisplay(value) {
      document.getElementById('inflationRateLabel').textContent = `ðŸ“ˆ Inflation Rate (${value}%)`;
    }

    // Function to format numbers with spaces (e.g., 1234567 -> R1 234 567)
    function formatNumber(num) {
      return 'R' + Math.round(num).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ' ');
    }

    // Function to format percentage
    function formatPercent(num) {
      return num.toFixed(2) + '%';
    }

    // Function to unformat input on focus (remove spaces for editing)
    function unformatInput(element) {
      const value = element.value.replace(/[^0-9.]/g, '');
      element.value = value;
    }

    // Function to format input fields with spaces on blur
    function formatInput(element) {
      const value = parseFloat(element.value.replace(/[^0-9.]/g, '')) || 0;
      element.value = Math.round(value).toLocaleString('en-ZA', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
    }

    function calculate() {
      // Parse inputs, removing any non-numeric characters (spaces, etc.)
      const P = parseFloat(document.getElementById('initialInvestment').value.replace(/[^0-9.]/g, '')) || 0;
      const t = parseFloat(document.getElementById('years').value) || 1;
      const PMT = parseFloat(document.getElementById('monthlyContribution').value.replace(/[^0-9.]/g, '')) || 0;
      const r = parseFloat(document.getElementById('rate').value) / 100 || 0;
      const i = parseFloat(document.getElementById('inflationRate').value) / 100 || 0;
      const n = 12; // Monthly compounding
      const monthlyExemption = 23800 / 12; // R23.8k annual exemption / 12
      const marginalRate = 0.45; // Hardcoded top bracket for interest tax
      const effectiveCgtRate = 0.18; // Hardcoded effective max for CGT

      // Total invested (base cost)
      const totalInvested = P + PMT * n * t;

      // Compound interest with monthly contributions for final year
      const futureValue = P * Math.pow(1 + r/n, n*t) + PMT * ((Math.pow(1 + r/n, n*t) - 1) / (r/n));
      const monthlyInterest = futureValue * (r/12);
      const totalRealValue = futureValue / Math.pow(1 + i, t);
      const monthlyRealInterest = monthlyInterest / Math.pow(1 + i, t);

      // Post-tax calculations (SARS 2025 rules, simplified)
      // Total cash-out: Effective 18% CGT on net gain after exclusion
      const capitalGain = Math.max(0, futureValue - totalInvested);
      const netGainAfterExclusion = Math.max(0, capitalGain - 40000); // R40k annual exclusion
      const cgtTax = netGainAfterExclusion * effectiveCgtRate;
      const postTaxTotal = futureValue - cgtTax;
      const postTaxRealTotal = postTaxTotal / Math.pow(1 + i, t);

      // Monthly interest: Tax on interest income at 45% after exemption
      const taxableMonthlyInterest = Math.max(0, monthlyInterest - monthlyExemption);
      const taxOnMonthlyInterest = taxableMonthlyInterest * marginalRate;
      const postTaxMonthlyInterest = monthlyInterest - taxOnMonthlyInterest;
      const postTaxRealMonthlyInterest = postTaxMonthlyInterest / Math.pow(1 + i, t);

      // Effective tax percentage on total withdrawal
      const effectiveTaxPercent = futureValue > 0 ? (cgtTax / futureValue) * 100 : 0;

      // Display results
      document.getElementById('totalValue').textContent = formatNumber(futureValue);
      document.getElementById('monthlyInterest').textContent = formatNumber(monthlyInterest);
      document.getElementById('totalRealValue').textContent = formatNumber(totalRealValue);
      document.getElementById('monthlyRealInterest').textContent = formatNumber(monthlyRealInterest);
      document.getElementById('totalInvested').textContent = formatNumber(totalInvested);
      document.getElementById('postTaxTotal').textContent = formatNumber(postTaxTotal);
      document.getElementById('postTaxMonthlyInterest').textContent = formatNumber(postTaxMonthlyInterest);
      document.getElementById('postTaxRealTotal').textContent = formatNumber(postTaxRealTotal);
      document.getElementById('postTaxRealMonthlyInterest').textContent = formatNumber(postTaxRealMonthlyInterest);
      document.getElementById('effectiveTaxPercent').textContent = formatPercent(effectiveTaxPercent);
      document.getElementById('results').classList.remove('hidden');
      document.getElementById('chartContainer').classList.remove('hidden');
      document.getElementById('barChartContainer').classList.remove('hidden');
      document.getElementById('yearlyTable').classList.remove('hidden');

      // Generate chart data (yearly)
      const labels = Array.from({length: t + 1}, (_, i) => i);
      const preTaxData = labels.map(year => {
        return P * Math.pow(1 + r/n, n*year) + PMT * ((Math.pow(1 + r/n, n*year) - 1) / (r/n));
      });
      const postTaxData = labels.map(year => {
        const yearlyValue = P * Math.pow(1 + r/n, n*year) + PMT * ((Math.pow(1 + r/n, n*year) - 1) / (r/n));
        const yearlyCapitalGain = Math.max(0, yearlyValue - (P + PMT * n * year));
        const yearlyNetGainAfterExclusion = Math.max(0, yearlyCapitalGain - 40000);
        const yearlyCgtTax = yearlyNetGainAfterExclusion * effectiveCgtRate;
        return yearlyValue - yearlyCgtTax;
      });
      const realValueData = preTaxData.map(value => value / Math.pow(1 + i, t));

      // Generate bar chart data with tax details
      const postTaxFutureValueData = labels.map(year => {
        const yearlyValue = P * Math.pow(1 + r/n, n*year) + PMT * ((Math.pow(1 + r/n, n*year) - 1) / (r/n));
        const yearlyCapitalGain = Math.max(0, yearlyValue - (P + PMT * n * year));
        const yearlyNetGainAfterExclusion = Math.max(0, yearlyCapitalGain - 40000);
        const yearlyCgtTax = yearlyNetGainAfterExclusion * effectiveCgtRate;
        const postTaxYearlyValue = yearlyValue - yearlyCgtTax;
        return postTaxYearlyValue / Math.pow(1 + i, year);
      });
      const postTaxInterestData = labels.map(year => {
        const yearlyValue = P * Math.pow(1 + r/n, n*year) + PMT * ((Math.pow(1 + r/n, n*year) - 1) / (r/n));
        const yearlyInterest = yearlyValue * (r/12);
        const taxableYearlyInterest = Math.max(0, yearlyInterest - monthlyExemption);
        const taxOnYearlyInterest = taxableYearlyInterest * marginalRate;
        const postTaxYearlyInterest = yearlyInterest - taxOnYearlyInterest;
        return postTaxYearlyInterest * 12; // Annualize
      });
      const postTaxFutureInterestData = labels.map(year => {
        const yearlyValue = P * Math.pow(1 + r/n, n*year) + PMT * ((Math.pow(1 + r/n, n*year) - 1) / (r/n));
        const yearlyInterest = yearlyValue * (r/12);
        const taxableYearlyInterest = Math.max(0, yearlyInterest - monthlyExemption);
        const taxOnYearlyInterest = taxableYearlyInterest * marginalRate;
        const postTaxYearlyInterest = yearlyInterest - taxOnYearlyInterest;
        return (postTaxYearlyInterest * 12) / Math.pow(1 + i, year); // Annualize and adjust for inflation
      });

      // Store tax data for tooltips
      const cgtTaxData = labels.map(year => {
        const yearlyValue = P * Math.pow(1 + r/n, n*year) + PMT * ((Math.pow(1 + r/n, n*year) - 1) / (r/n));
        const yearlyCapitalGain = Math.max(0, yearlyValue - (P + PMT * n * year));
        const yearlyNetGainAfterExclusion = Math.max(0, yearlyCapitalGain - 40000);
        return yearlyNetGainAfterExclusion * effectiveCgtRate;
      });
      const interestTaxData = labels.map(year => {
        const yearlyValue = P * Math.pow(1 + r/n, n*year) + PMT * ((Math.pow(1 + r/n, n*year) - 1) / (r/n));
        const yearlyInterest = yearlyValue * (r/12);
        const taxableYearlyInterest = Math.max(0, yearlyInterest - monthlyExemption);
        return taxableYearlyInterest * marginalRate * 12; // Annualize
      });

      // Determine scale type based on toggle
      const logScaleToggle = document.getElementById('logScaleToggle').checked;
      const yAxisType = logScaleToggle ? 'logarithmic' : 'linear';

      // Update or create line chart
      if (chart) chart.destroy();
      chart = new Chart(document.getElementById('growthChart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Pre-Tax Value (R)',
              data: preTaxData,
              borderColor: '#3b82f6',
              fill: false
            },
            {
              label: 'Post-Tax Value (R)',
              data: postTaxData,
              borderColor: '#10b981',
              fill: false
            },
            {
              label: 'Inflation-Adjusted Value (R)',
              data: realValueData,
              borderColor: '#f59e0b',
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { 
              title: { display: true, text: 'Years', color: '#d1d5db', font: { size: window.innerWidth < 640 ? 10 : 12 } }, 
              ticks: { color: '#d1d5db', font: { size: window.innerWidth < 640 ? 8 : 10 } } 
            },
            y: { 
              type: yAxisType,
              title: { display: true, text: 'Value (R)', color: '#d1d5db', font: { size: window.innerWidth < 640 ? 10 : 12 } }, 
              ticks: { 
                color: '#d1d5db', 
                font: { size: window.innerWidth < 640 ? 8 : 10 },
                callback: function(value) {
                  return 'R' + value.toLocaleString('en-ZA', { minimumFractionDigits: 0 });
                }
              },
              min: 0
            }
          },
          plugins: {
            legend: { 
              labels: { 
                color: '#d1d5db', 
                font: { size: window.innerWidth < 640 ? 8 : 10 }
              } 
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  label += formatNumber(context.parsed.y);
                  return label;
                }
              }
            }
          }
        }
      });

      // Update or create bar chart with enhanced tooltips
      if (barChart) barChart.destroy();
      barChart = new Chart(document.getElementById('postTaxBarChart'), {
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            {
              label: 'Post-Tax Future Value (R)',
              data: postTaxFutureValueData,
              backgroundColor: '#10b981',
            },
            {
              label: 'Post-Tax Interest (Annual, R)',
              data: postTaxInterestData,
              backgroundColor: '#3b82f6',
            },
            {
              label: 'Post-Tax Future Interest (Annual, R)',
              data: postTaxFutureInterestData,
              backgroundColor: '#f59e0b',
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: { 
              title: { display: true, text: 'Years', color: '#d1d5db', font: { size: window.innerWidth < 640 ? 10 : 12 } }, 
              ticks: { color: '#d1d5db', font: { size: window.innerWidth < 640 ? 8 : 10 } } 
            },
            y: { 
              type: yAxisType,
              title: { display: true, text: 'Value (R)', color: '#d1d5db', font: { size: window.innerWidth < 640 ? 10 : 12 } }, 
              ticks: { 
                color: '#d1d5db', 
                font: { size: window.innerWidth < 640 ? 8 : 10 },
                callback: function(value) {
                  return 'R' + value.toLocaleString('en-ZA', { minimumFractionDigits: 0 });
                }
              },
              min: 0
            }
          },
          plugins: {
            legend: { 
              labels: { 
                color: '#d1d5db', 
                font: { size: window.innerWidth < 640 ? 8 : 10 }
              } 
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const year = context.dataIndex;
                  let label = context.dataset.label || '';
                  if (label) {
                    label += ': ';
                  }
                  label += formatNumber(context.parsed.y);
                  if (context.dataset.label === 'Post-Tax Future Value (R)') {
                    label += `\nCGT: ${formatNumber(cgtTaxData[year])}`;
                  } else if (context.dataset.label.includes('Interest')) {
                    label += `\nInterest Tax (Annual): ${formatNumber(interestTaxData[year])}`;
                  }
                  return label.split('\n');
                }
              }
            }
          }
        }
      });

      // Generate yearly tables with sampling
      const tableBodyValue = document.getElementById('tableBodyValue');
      const tableBodyInterest = document.getElementById('tableBodyInterest');
      const tableBodyPostTaxInterest = document.getElementById('tableBodyPostTaxInterest');
      tableBodyValue.innerHTML = '';
      tableBodyInterest.innerHTML = '';
      tableBodyPostTaxInterest.innerHTML = '';
      const showAllYears = document.getElementById('showAllYears').checked;
      const step = (t > 15 && !showAllYears) ? 5 : 1;
      const yearsToShow = [];
      for (let year = 1; year <= t; year += step) {
        yearsToShow.push(year);
      }
      if (!yearsToShow.includes(t)) {
        yearsToShow.push(t); // Always include the final year
      }
      for (const year of yearsToShow) {
        const yearlyValue = P * Math.pow(1 + r/n, n*year) + PMT * ((Math.pow(1 + r/n, n*year) - 1) / (r/n));
        const yearlyFutureValue = yearlyValue / Math.pow(1 + i, year);
        const yearlyInterest = yearlyValue * (r/12);
        const yearlyFutureInterest = yearlyInterest / Math.pow(1 + i, year);
        const taxableYearlyInterest = Math.max(0, yearlyInterest - monthlyExemption);
        const taxOnYearlyInterest = taxableYearlyInterest * marginalRate;
        const postTaxYearlyInterest = yearlyInterest - taxOnYearlyInterest;
        const postTaxYearlyFutureInterest = postTaxYearlyInterest / Math.pow(1 + i, year);
        
        // Value table
        const valueRow = `<tr>
          <td class="p-2 sm:p-3 border border-gray-600 text-center text-white whitespace-normal">${year}</td>
          <td class="p-2 sm:p-3 border border-gray-600 text-center text-white whitespace-normal">${formatNumber(yearlyValue)}</td>
          <td class="p-2 sm:p-3 border border-gray-600 text-center text-white whitespace-normal">${formatNumber(yearlyFutureValue)}</td>
        </tr>`;
        tableBodyValue.innerHTML += valueRow;

        // Interest table
        const interestRow = `<tr>
          <td class="p-2 sm:p-3 border border-gray-600 text-center text-white whitespace-normal">${year}</td>
          <td class="p-2 sm:p-3 border border-gray-600 text-center text-white whitespace-normal">${formatNumber(yearlyInterest)}</td>
          <td class="p-2 sm:p-3 border border-gray-600 text-center text-white whitespace-normal">${formatNumber(yearlyFutureInterest)}</td>
        </tr>`;
        tableBodyInterest.innerHTML += interestRow;

        // Post-tax interest table
        const postTaxInterestRow = `<tr>
          <td class="p-2 sm:p-3 border border-gray-600 text-center text-white whitespace-normal">${year}</td>
          <td class="p-2 sm:p-3 border border-gray-600 text-center text-white whitespace-normal">${formatNumber(postTaxYearlyInterest)}</td>
          <td class="p-2 sm:p-3 border border-gray-600 text-center text-white whitespace-normal">${formatNumber(postTaxYearlyFutureInterest)}</td>
        </tr>`;
        tableBodyPostTaxInterest.innerHTML += postTaxInterestRow;
      }
    }

    // Initialize display values
    updateYearsDisplay(document.getElementById('years').value);
    updateRateDisplay(document.getElementById('rate').value);
    updateInflationRateDisplay(document.getElementById('inflationRate').value);
  </script>
</body>
</html>
